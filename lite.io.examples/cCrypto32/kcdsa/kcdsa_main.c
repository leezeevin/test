#include <stdio.h>
#include "kcdsa.h"
#include "__util.h"

//void keyChange(uint8_t* p, int32_t size)
//{
//		uint8_t tmp;
//
//		for (int32_t i = 0; i < size / 2; i++)
//		{
//				tmp = p[i];
//				p[i] = p[size - i - 1];
//				p[size-i - 1] = tmp;
//		}
//}

void kcdsa_main() {
		KISA_KCDSA* kcdsa = NULL;

		int32_t plen = 2048, qlen = 224;
		uint8_t msg[] = { 0x54, 0x68, 0x69, 0x73, 0x20, 0x69, 0x73, 0x20, 0x61, 0x20, 0x74, 0x65, 0x73, 0x74, 0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x20, 0x66, 0x6f, 0x72, 0x20, 0x4b, 0x43, 0x44, 0x53, 0x41, 0x20, 0x75, 0x73, 0x61, 0x67, 0x65, 0x21 };

		uint8_t pbSrc[] = { 0x73, 0x61, 0x6c, 0x64, 0x6a, 0x66, 0x61, 0x77, 0x70, 0x33, 0x39, 0x39, 0x75, 0x33, 0x37, 0x34, 0x72, 0x30, 0x39, 0x38, 0x75, 0x39, 0x38, 0x5e, 0x25, 0x5e, 0x25, 0x68, 0x6b, 0x72, 0x67, 0x6e, 0x3b, 0x6c, 0x77, 0x6b, 0x72, 0x70, 0x34, 0x37, 0x74, 0x39, 0x33, 0x63, 0x25, 0x24, 0x38, 0x39, 0x34, 0x33, 0x39, 0x38, 0x35, 0x39, 0x6b, 0x6a, 0x64, 0x6d, 0x6e, 0x76, 0x63, 0x6d, 0x20, 0x63, 0x76, 0x6b, 0x20, 0x6f, 0x34, 0x75, 0x30, 0x39, 0x72, 0x20, 0x34, 0x6a, 0x20, 0x6f, 0x6a, 0x32, 0x6f, 0x75, 0x74, 0x32, 0x30, 0x39, 0x78, 0x66, 0x71, 0x77, 0x3b, 0x6c, 0x2a, 0x26, 0x21, 0x5e, 0x23, 0x40, 0x55, 0x23, 0x2a, 0x23, 0x24, 0x29, 0x28, 0x23, 0x20, 0x7a, 0x20, 0x78, 0x6f, 0x39, 0x35, 0x37, 0x74, 0x63, 0x2d, 0x39, 0x35, 0x20, 0x35, 0x20, 0x76, 0x35, 0x6f, 0x69, 0x75, 0x76, 0x39, 0x38, 0x37, 0x36, 0x20, 0x36, 0x20, 0x76, 0x6a, 0x20, 0x6f, 0x35, 0x69, 0x75, 0x76, 0x2d, 0x30, 0x35, 0x33, 0x2c, 0x6d, 0x63, 0x76, 0x6c, 0x72, 0x6b, 0x66, 0x77, 0x6f, 0x72, 0x65, 0x74 };
		uint8_t kInput[] = { 0x1b, 0xf1, 0x23, 0xb0, 0x27, 0x52, 0xe2, 0xc9, 0xed, 0x81, 0x51, 0x74, 0x69, 0xf2, 0x0b, 0x0c, 0x19, 0xa9, 0x97, 0xa4 };
		uint8_t sig[102] = { 0 };
		uint32_t siglen = 0;
		int32_t ret = 0;

		int32_t mSize = 0;
		
//1
		/*uint8_t sp[] = "8EBAF0658E1C4D432BFC2835FEE088CC9E5EDB8FD06AEB48177594F9B2DC31E37517ECEDFB018F827380A24DABA5D916AEDEAA9D7DC767DC760E81E635BD7610EFAB9C199C03F6A6AE2B1FC825E9824E08C756F69AE4356A0DCC7BC46C227B6FABEDCC1CD61D04720A1B790C254BFCE0811BB657761A57D3764E438CE2C0B33D04BA28EF043A575FE8A062727FA4BB122C2EADEB1EB30B81E36702A25A4AAD20A96A9EE28594B232385ED740D8291FD6CB97B25AC18207C1AF33E2E86B16DDAD55BF4C49938F3F31B1DFD806DC9A637220F693005D33863655920EB5A0FF2E4922C138D12BA99112F9312CCEB2EE55DBC079E3D6A3C5D1CBDDDEC6B6E7BDD19F";
		uint8_t sq[] = "8D492391758CDFAFDF2F1DED9C7C1A6B28A3FAF259DA6FF1878EEE07";
		uint8_t sg[] = "6EC9C5EA61CDAA4163DCC4DA8C5FEC6CC5469CDC3D86169A9E022DA08DC218C2757183DB9F7E9B49CF9E860C528E92F771EF4ED6C2D796A903D588BC0514219B239AB94084B7AB83F90ABEF19BC012347C0D2ECFD0EE80D65C08861D54272FB648759E1ADE2D55BAD3C050E4F066670B36468398BE6CBA75FD518B8DAE123773C95CC81D789776C62CBFBA0A8CC7CE0A2EC1040D87320D0E91A851C36F4BD1D1C23140B548F9D994B8E4ECC3C73356B709B47563F56CEBBE1048BE3FCCF3E0217B996A1C022ED9026131F00677A17387D884336D28BC0F386B07B30C3EA36118D057299D24685E9BE7B1652508AB3ABA36D03E37C8F9EE0579BBAEDB58AFF7DC";
		uint8_t sm[] = "DF7ED9AB6884F692A31752B549E8B3AD479A87B3F0B42869C307CDB20E4DC98B724E4486A04A11E033FBD6B923EF1682A281611CDB443FB7751CFDFA42D01A73FE615CE694EF5176C166533081CFBE1037857EF1F1079F82A8CD03C1F9CDEDFE27067C03E4D5D047B45CF5DB63C637F471A818BCD553855107556E99B8F671DD1EF1C3B83747F16EFC4FAE20D3F654F3425236AD336679D1C75894BF0EE11FE798401B8C3D755C2D12143A10E36D32F92456A49FBE6648DAA3E095178F0FB61ED27634ACAC7B03EFF7EC1A62AC1D351B19EBF7133162076AE260572BD8E93EA9958287EE445A2147327C9A754FE40794ACB38B33504F14A74EB4892F8FBE08DA2EB956D0CDFD37EED4D4CC51F5859ECBF0B786D0E60C15E13B1EA20061C5AA2973D7A87615350FC8756B8BA6D0AC344B7E69D463C65EF98D884AE11E03210537C2024FAFF5BDBBDE35217BCB19ED4DC879A02A0FCCF4F44B964B4DB833D740CC03C6E4F04A369565BD3B06BF12C5B6218B9F059DDB6484E0549BB3A1B6D9CCD9A31AC657FE2B3EB53D6A5E2B03978258E60EAA7EDF2B703C351EAC545A006076985920A9FE0EA0526EC47F5E3EB00E9B45FE25CCC9B0C575351F96F4F308FBE36149E2534239EDE690C92C4F1D43FB3EEAE94C489740DACADA51984E5F9CE68B0516C46CCAEDA0456A5FEE9E006D38BE9FAFBA5D";
		uint8_t sx[] = "6EE602B8815ABE058E731CE10552FAD89E07C623D1898F4B2CC7C316"; 
		uint8_t sy[] = "4BF94F782B0ACA739D31830B798C589B62037EB3C216C9E0F795B9DF044545B3AC0871926BD4F707018A33584E1145F6BB596B3239562EA38E9DCA7FCCA5439D1EBE7AE87316232E922AD4DA792DC8540E6ED4D782051AE9C86ACB587D915608EB534B411266FCCBEB3AACC6CB1A8D47D29B349DF5680B4C32AF6F4F97CB7109EA0895F9F1737939E7F0DCA6BF52888961A4CFCED17E72508F7AC6D6D6FFB309A9DEEBA3C7F7270CC32E926F339A2EA0847237D369F7AD329498051B9221E151A272F0EA38D2F77BC2292B2604B7C646FB080DD11FBEB8590803A3A654BAC52CF4A82CE0496D0918958F95C567E31DF1FF92171F7EFF75B4520F3B9A7F79D23E";

		uint8_t sr[] = "3610CF67C006E65A449C298DEA7BE30DC199BDB7226EE60D4FB82BE7";
		uint8_t ss[] = "4C42687E08185574FDCDDF21854A51C56B5D98A5789B31E098351C09";*/

//2
		uint8_t sp[] = "cb5d7483097c239b8d288d0196e52943b05a567208fedbfba1a73cf8c61b4df6dd69fd8b3db8944ed66e47c7a07bd3d802d5cb3ee3ea0ca2e485027ce8d8886cea42d6d4cd99ca2946b74101ee894c6d53f10a782cc142544f7218992367be0fd448e76810072b2471f43aaf706656ff086edfe6683932171d199f2ef9431d8d9c59de46cdd27a9b10f303b5bf9edc3be32fc24f83e8090586d8d954318cb63d2495c31e84e20f630d03753fee6daa0720849dbbc003f171c4efcaa0b3cb99a9531b7627183321d86c8836e5c3acbc472d15779ab1f9efa7230adc8d7c263625472b87c6083c48140d85017ade8ad59818bf120f09ec4582ff6532d5f446ac7b";
		uint8_t sq[] = "6b39cf615e729134e92da1091dc75127f6d7a55d4a899679ed33363e";
		uint8_t sg[] = "7f04ffa658970d44117e15cdfff4a0ec085df7d5fee3424169ac3339b3fd613a9c54050b793217dc96c45475d4d82da9abfc395e206c9be6762a98b921766ecbccf04f8ea74b9825fb18097e9c35a4528be36df0f57e0bdee180dfd1cfac931e2d99c030051af2b5241a1df8525542a4b2e7517055bb86362be7cb727879b90d739e3a71b08e07b477df576496060f70ee44398b0751dbf4d3ed8c52b3ad396b9ba6c61a2ad2e4ee4c4ba2cd34199476709039f3784959505ebff7dbd19cb923f5ccf5ddb17a1b63a35914199a6a1677578229659c54e991a98d307e9f1c1af545c258f2b4511ec59f57f0d606d177cf8a7b14de9c053e34a01101a1e52e008d";
		uint8_t sm[] = "df7ed9ab6884f692a31752b549e8b3ad479a87b3f0b42869c307cdb20e4dc98b724e4486a04a11e033fbd6b923ef1682a281611cdb443fb7751cfdfa42d01a73fe615ce694ef5176c166533081cfbe1037857ef1f1079f82a8cd03c1f9cdedfe27067c03e4d5d047b45cf5db63c637f471a818bcd553855107556e99b8f671dd1ef1c3b83747f16efc4fae20d3f654f3425236ad336679d1c75894bf0ee11fe798401b8c3d755c2d12143a10e36d32f92456a49fbe6648daa3e095178f0fb61ed27634acac7b03eff7ec1a62ac1d351b19ebf7133162076ae260572bd8e93ea9958287ee445a2147327c9a754fe40794acb38b33504f14a74eb4892f8fbe08da2eb956d0cdfd37eed4d4cc51f5859ecbf0b786d0e60c15e13b1ea20061c5aa2973d7a87615350fc8756b8ba6d0ac344b7e69d463c65ef98d884ae11e03210537c2024faff5bdbbde35217bcb19ed4dc879a02a0fccf4f44b964b4db833d740cc03c6e4f04a369565bd3b06bf12c5b6218b9f059ddb6484e0549bb3a1b6d9ccd9a31ac657fe2b3eb53d6a5e2b03978258e60eaa7edf2b703c351eac545a006076985920a9fe0ea0526ec47f5e3eb00e9b45fe25ccc9b0c575351f96f4f308fbe36149e2534239ede690c92c4f1d43fb3eeae94c489740dacada51984e5f9ce68b0516c46ccaeda0456a5fee9e006d38be9fafba5d";
		uint8_t sx[] = "d455773c24d962383d6a3e87e61dab43539d199d9e1bf6682aca5fa2";
		uint8_t sy[] = "26147376a7f1f9a3602254159edab80fc4d4025bf42c8b1eb97cccb679cefd9bad025159f61f67783adbdfc819e9e4c34ac8c5df0ffd717d36381212af5e053eaecb708a6d023715a6dd2c337d1d7bb37c87c4548aee2a4d91603bf2b7c04c8ae8f2b342f1ee181effb1b94c523d9fd3adbd3d6f8dd0aaafacfe2d22975edab6f707ad294e9d78bd3c867f25d35132336e0a8e63b2708feac8821882c6dead21dbc8c9ba8a7f52ce789209140078b46233a7f722cd5ad1052cf829e28ff3fc6ef546d4a29e787ca4ff89c244be3d4398cb153527229601dce9edaa803b1fda69efc66e28879b70b190b493d8cee663814c1b9908bf922654872392951498fca9";

		uint8_t sr[] = "ecc64a0c694e8b136de7c777cbd14fdf199b1e773bda3be6189352ea";
		uint8_t ss[] = "522dddb9475b2df6bcd53433ae2f48275d2861541f4c803bd412b462";

//3
		/*uint8_t sp[] = "190B5F5751D35A762E260A014D76F3F9DCCA1BB29A44570AD0563545371FCCE16FC33BAD1E506D1707BEADEBAF9BA25C2DD909B727B2D0C6C26207FD946AB44C4755E71A6F275C5819724ED4A3A377995954932BD8C80ECE3271D4BCF5C1C3196A0160FCD5618605A857ABB1755EC267BAB08CA3CD01F356242DE9FF17CFC8B6753781252781D54E96A0F53CB9FD01370739A7A092293EB508D44D9DDAD0CD7C5D2F00429C9E120B3BF93B5D983466F83042A6F97F826EFD1D2CC1FEE6D4352BD8F120190FC2A469415211E84E01076B8DC29E22616C632DABFFAF2E959F4890A583FF6CE6B9B202AC3CD6B27A4B3F9482975A09D59D8781DA0BE9A1908A1F76";
		uint8_t sq[] = "957C97C90C0E37E255299C50A14B9ED6B5F62D0AF6DA905F83CF7590";
		uint8_t sg[] = "B516AAA27F951B9673A4FAC859FE6B1C132723E0CDD0821C3EA50AF6448DD89652AABB8C0074DD26C2CF78F404EB906796C4B1E85939EFC3BC653E6CC54F1B885DB459D5C7CFDD7030428E7652C46257F5275C0E796D76CAE84EB5D59A4411428B78E694F2EE68791AC18446FCE6151BDA857193FDBC5619D531A90C3A639FA046C72A23D7ACE6B581FA5F5E05216D2AFC1AA6315FC165B722254A272E51B08AE4C06B8F2846BB175C6DCBADA3B4E2D670C679C8C8DFA4F1C1C71B2E76C4D51CE033088F84D534EA5CA1EA74B1BBE5CBFAFE8263FE9D142EFF9587D9A8BF03D26E698139950E0753A7D9372E313EDD1B3581AFAB01DB08105ECDBE03102BB896";
		uint8_t sm[] = "DF7ED9AB6884F692A31752B549E8B3AD479A87B3F0B42869C307CDB20E4DC98B724E4486A04A11E033FBD6B923EF1682A281611CDB443FB7751CFDFA42D01A73FE615CE694EF5176C166533081CFBE1037857EF1F1079F82A8CD03C1F9CDEDFE27067C03E4D5D047B45CF5DB63C637F471A818BCD553855107556E99B8F671DD1EF1C3B83747F16EFC4FAE20D3F654F3425236AD336679D1C75894BF0EE11FE798401B8C3D755C2D12143A10E36D32F92456A49FBE6648DAA3E095178F0FB61ED27634ACAC7B03EFF7EC1A62AC1D351B19EBF7133162076AE260572BD8E93EA9958287EE445A2147327C9A754FE40794ACB38B33504F14A74EB4892F8FBE08DA2EB956D0CDFD37EED4D4CC51F5859ECBF0B786D0E60C15E13B1EA20061C5AA2973D7A87615350FC8756B8BA6D0AC344B7E69D463C65EF98D884AE11E03210537C2024FAFF5BDBBDE35217BCB19ED4DC879A02A0FCCF4F44B964B4DB833D740CC03C6E4F04A369565BD3B06BF12C5B6218B9F059DDB6484E0549BB3A1B6D9CCD9A31AC657FE2B3EB53D6A5E2B03978258E60EAA7EDF2B703C351EAC545A006076985920A9FE0EA0526EC47F5E3EB00E9B45FE25CCC9B0C575351F96F4F308FBE36149E2534239EDE690C92C4F1D43FB3EEAE94C489740DACADA51984E5F9CE68B0516C46CCAEDA0456A5FEE9E006D38BE9FAFBA5D";
		uint8_t sx[] = "50C912768A84FCD44CC7FE84AF5B24BB9779D1BEE9C5D4466AF55AC7";
		uint8_t sy[] = "D7900DA34C78769F9C8827F9DE45083790F03E328396E733BC2CF8F163C4706CC8E8E0F1CAD59B6528DBDF88B3DD2ADCAA24DDB6282C5701A698C4EADE25913D9287294E75A6EF19C39BF836336E998F29592902D6CBD9BBE3E0D175EACBF657CCF8B8CE6999045BC7661D7337608C0E7D3E0509E4BFEAF5B6186DB7ACFB199A986107658958BCB422A956C59D4AAA238A54F8684D01DC774FC80BEE2E0900A7C0D5AE7AF8AE479202FDBF6BA90977A70505C6360A2E568FD2FD73F8DE367AF1A45DAB6431B89B418248CB3ABC844407995A2ACC10697A7C29715241E6A90D430B50E0B25D6F4E885DB147274B1360FAC61681243F4E2D1A22CA58C71C2A751A";

		uint8_t sr[] = "4D402FEEA093D40E31D9410FDE0AC03E9A94C9C23D1B128D7CC33247";
		uint8_t ss[] = "66B21C22591B283128D0F5BC0D704BF76749AD0DC13700089362FD67";*/

		uint8_t m[(sizeof(sm) - 1) / 2] = { 0, };
		uint32_t* p = calloc((sizeof(sp) - 1) / 8, sizeof(uint32_t));
		uint32_t* q = calloc((sizeof(sq) - 1) / 8, sizeof(uint32_t));
		uint32_t* g = calloc((sizeof(sg) - 1) / 8, sizeof(uint32_t));
		uint32_t* x = calloc((sizeof(sx) - 1) / 8, sizeof(uint32_t));
		uint32_t* y = calloc((sizeof(sy) - 1) / 8, sizeof(uint32_t));


		bigNumToArray(sp, (sizeof(sp) - 1), p);
		bigNumToArray(sq, (sizeof(sq) - 1), q);
		bigNumToArray(sg, (sizeof(sg) - 1), g);
		bigNumToArray(sx, (sizeof(sx) - 1), x);
		bigNumToArray(sy, (sizeof(sy) - 1), y);
		toHex(sm, m, &mSize);

		KISA_KCDSA_CreateObject(&kcdsa);
		//KISA_KCDSA_GenerateParameters(plen, qlen, kcdsa, SHA224);
		//KISA_KCDSA_GenerateKeyPair(kcdsa, pbSrc, 160, qlen, SHA224);
		KISA_KCDSA_set_params(kcdsa, p, (sizeof(sp) - 1) / 8, q, (sizeof(sq) - 1) / 8, g, (sizeof(sg) - 1) / 8, x, (sizeof(sx) - 1) / 8, y, (sizeof(sy) - 1) / 8);
		//if (MillerRabin(kcdsa->KCDSA_P) != CTR_SUCCESS) {printf("KCDSA->P Error\n");}
		//if (MillerRabin(kcdsa->KCDSA_Q) != CTR_SUCCESS) {printf("KCDSA->Q Error\n");}
		//KISA_KCDSA_sign(kcdsa, m, mSize, sig, &siglen, SHA224, kInput, 20);
		//KISA_KCDSA_sign(kcdsa, msg, 39, sig, &siglen, SHA224, kInput, 20);

		//bigNumToArray(&a, 16, p);
		//printf("P \n");
		//for (int i = 0; i < kcdsa->KCDSA_P->Length; i++)
		//{
		//		//if (i % 4 == 0 && i != 0) printf("\n");
		//		printf("%08X", kcdsa->KCDSA_P->pData[i]);
		//}
		//printf("\n\nQ \n");
		//for (int i = 0; i < kcdsa->KCDSA_Q->Length; i++)
		//{
		//		//if (i % 4 == 0 && i != 0) printf("\n");
		//		printf("%08X", kcdsa->KCDSA_Q->pData[i]);
		//}
		//printf("\n\nG \n");
		//for (int i = 0; i < kcdsa->KCDSA_G->Length; i++)
		//{
		//		//if (i % 4 == 0 && i != 0) printf("\n");
		//		printf("%08X", kcdsa->KCDSA_G->pData[i]);
		//}
		//printf("\n\nX \n");
		//for (int i = 0; i < kcdsa->KCDSA_x->Length; i++)
		//{
		//		//if (i % 4 == 0 && i != 0) printf("\n");
		//		printf("%08X", kcdsa->KCDSA_x->pData[i]);
		//}
		//printf("\n\nY \n");
		//for (int i = 0; i < kcdsa->KCDSA_y->Length; i++)
		//{
		//		//if (i % 4 == 0 && i != 0) printf("\n");
		//		printf("%08X", kcdsa->KCDSA_y->pData[i]);
		//}
		//printf("\n\n");
		//for (int i = 0; i < (sizeof(sm) - 1) / 2; i++)
		//{
		//		if (i % 4 == 0 && i != 0) printf(" ");
		//		if (i % 16 == 0 && i != 0) printf("\n");
		//		printf("%02X", m[i]);
		//}
		//printf("\n\n");
		//
		toHex(&sr, &sig, &siglen);
		toHex(&ss, &sig, &siglen);
		//

		for (int32_t i = 0; i < 28; ++i) {
				printf("%02X ", sig[i]);
		}
		printf("\n");
		for (int32_t i = 28; i < 56; ++i) {
				printf("%02X ", sig[i]);
		}
		printf("\n");

		ret = KISA_KCDSA_verify(kcdsa, m, mSize, sig, siglen, SHA224);
		//ret = KISA_KCDSA_verify(kcdsa, msg, 39, sig, siglen, SHA224);
		if (ret == CTR_SUCCESS)
				printf("verify : Success\n");
		else
				printf("verify : Fail\n");

		//free(p); free(q); free(g); free(x); free(y);
		KISA_KCDSA_DestroyObject(&kcdsa);
}