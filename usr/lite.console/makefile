################################################################################
#                                                                              #
#                                                                              #
#                                   PART I                                     #
#                                                                              #
#                                                                              #
################################################################################
################################################################################
#                                                                              #
#                                  COMMON                                      #
#                                                                              #
################################################################################
VERSION         = 2.0.0
LICENSE        ?= no

ARCH_TYPE      ?= x32
OUTPUT_TYPE ?= .a
#OUTPUT_TYPE ?= SHARED
#OUTPUT_TYPE ?= BINARY
################################################################################
#                                                                              #
#                                                                              #
#                                 PART II                                      #
#                                                                              #
#                                                                              #
################################################################################
################################################################################
#                                                                              #
#                                 COMPILER                                     #
#                                                                              #
################################################################################
COPT = -O2 -no-integrated-cpp
COPT += -fvisibility=hidden
#COPT = -g -ggdb -W -Wall -no-integrated-cpp -static-libgcc
COPT += -D__DEBUG__=$(DEBUG)

ifeq ($(ARCH_TYPE), x32)
	TOOLCHAIN_PATH = /usr
endif

ifeq ($(ARCH_TYPE), x64)
	TOOLCHAIN_PATH = /usr
endif

ifeq ($(ARCH_TYPE), a32) #####
	ifeq ($(ABI), HARD)
		TOOLCHAIN_PATH = /opt/ext/toolchain/x64/v7/arm-linux-gnueabihf/
	endif
	ifeq ($(ABI), SOFT)
		TOOLCHAIN_PATH = /opt/ext/toolchain/x64/v7/arm-linux-gnueabi/
	endif
endif #####

ifeq ($(ARCH_TYPE), a64)
	TOOLCHAIN_PATH = /opt/ext/toolchain/x64/v7/aarch64-linux-gnu
endif

ifeq ($(ARCH_TYPE), m32) #####
	TOOLCHAIN_PATH = /opt/ext/toolchain/x64/v7/arm-eabi/
endif #####

ifeq ($(ARCH_TYPE), x32)
	XCOMPILE- = 
	XTARGET   = x32
	COPT += -Dx32=1
	COPT += -m32
	COPT += -DPACKED
	COPT += -D__LINUX__=1
	COPT += -D__PACKED__=1
	COPT += -D__uCHIP__=0
endif

ifeq ($(ARCH_TYPE), x64)
	XCOMPILE- = 
	XTARGET   = x64
	COPT += -Dx64=1
	COPT += -m64
	COPT += -D__LINUX__=1
	COPT += -D__PACKED__=1
	COPT += -D__uCHIP__=0
endif

ifeq ($(ARCH_TYPE), a32) #####
	COPT += -Da32
	ifeq ($(ABI), HARD)
		XCOMPILE- = arm-linux-gnueabihf-
		XTARGET = ha32
    COPT += -Dha32=1
		COPT += -D__LINUX__=1
		COPT += -D__PACKED__=1
		COPT += -D__uCHIP__=0
		COPT += -DABI_HARD
		xCOPT += -mfloat-abi=hard
	endif
	ifeq ($(ABI), SOFT)
		XCOMPILE- = arm-linux-gnueabi-
		XTARGET = a32
    COPT += -Da32=1
		COPT += -D__LINUX__=1
		COPT += -D__PACKED__=1
		COPT += -D__uCHIP__=0
		COPT += -DABI_SOFT
		xCOPT += -mfloat-abi=soft
	endif
endif #####

ifeq ($(ARCH_TYPE), a64)
	COPT += -Da64
	XCOMPILE- = aarch64-linux-gnu-
	ifeq ($(ABI), HARD)
		XTARGET   = ha64
    COPT += -Dha64=1
		COPT += -D__LINUX__=1
		COPT += -D__PACKED__=1
		COPT += -D__uCHIP__=0
		COPT += -DABI_HARD
		COPT += -march=armv8-a
	endif
	ifeq ($(ABI), SOFT)
		XTARGET   = a64
    COPT += -Da64=1
		COPT += -D__LINUX__=1
		COPT += -D__PACKED__=1
		COPT += -D__uCHIP__=0
		COPT += -DABI_SOFT
		COPT += -march=armv8-a
	endif
endif

ifeq ($(ARCH_TYPE), m32) #####
	XCOMPILE- = arm-eabi-
	XTARGET = m32
  COPT += -Dm32=1
	COPT += -D__PACKED__=1
	COPT += -D__uCHIP__=1
	COPT += -mfloat-abi=hard
	COPT += -mcpu=cortex-m3
	COPT += -mthumb
	COPT += -std=gnu11
	COPT += -Os
	COPT += --specs=nano.specs
endif #####


TOOLCHAIN_BIN  = $(TOOLCHAIN_PATH)/bin/
TOOLCHAIN_LIB = $(TOOLCHAIN_PATH)/lib
ifeq ($(ARCH_TYPE), x64)
TOOLCHAIN_LIB = $(TOOLCHAIN_PATH)/lib64
endif

CC     = $(TOOLCHAIN_BIN)$(XCOMPILE-)gcc
AR     = $(TOOLCHAIN_BIN)$(XCOMPILE-)ar
RANLIB = $(TOOLCHAIN_BIN)$(XCOMPILE-)ranlib
AR_OPT = rcs


################################################################################
#                                                                              #
#                                  SUFFIX                                      #
#                                                                              #
################################################################################
C_SUFFIX = .c
O_SUFFIX = .o

ifeq ($(OUTPUT_TYPE), .so)
	COPT += -D__STATIC_LIB__=0
endif

ifeq ($(OUTPUT_TYPE), .a)
	COPT += -D__STATIC_LIB__=1
endif

################################################################################
#                                                                              #
#                              COMPILE OPTIONS                                 #
#                                                                              #
################################################################################

LIBS = -lnsl -lrt
RM = rm -rf
CP = cp -rf
MV = mv

################################################################################
#                                                                              #
#                                 DIRECTORIES                                  #
#                                                                              #
################################################################################
INC = .
SRC = .
LIB = lib
OBJ = obj
BIN = bin
OUT = out
COM = coms

################################################################################
################################################################################
#############################                 ##################################
#############################                 ##################################
#############################                 ##################################
#############################                 ##################################
##########################                       ###############################
###########################                     ################################
#############################                 ##################################
###############################             ####################################
#################################         ######################################
###################################     ########################################
##################################### ##########################################
################################################################################

################################################################################
#                                                                              #
#                                                                              #
#                            DIRECTORY INFORMATION                             #
#                                                                              #
#                                                                              #
################################################################################
include opt.mak

TARGET_OBJ = $(OUT)/$(_TARGET_NAME).$(OBJ).$(XTARGET)


#                                                                              #
#                                                                              #
################################################################################
##################################### ##########################################
###################################     ########################################
#################################         ######################################
###############################             ####################################
#############################                 ##################################
###########################                     ################################
##########################                       ###############################
#############################                 ##################################
#############################                 ##################################
#############################                 ##################################
#############################                 ##################################
################################################################################
################################################################################

################################################################################
#                                                                              #
#                            SOURCE CONVERTING                                 #
#                                                                              #
################################################################################
C_SRCS  = $(foreach dir, $(SRC), $(wildcard $(dir)/*$(C_SUFFIX)))
CXX_SRCS = $(foreach dir, $(SRC), $(wildcard $(dir)/*$(CXX_SUFFIX)))
OBJS = $(foreach dir, . $(TARGET_OBJ), $(wildcard $(dir)/*$(O_SUFFIX)))
OXXS = $(foreach dir, . $(TARGET_OBJ), $(wildcard $(dir)/*$(OXX_SUFFIX)))

################################################################################
#                                                                              #
#                             COMPILE OBJECT                                   #
#                                                                              #
################################################################################
%$(O_SUFFIX) :
	@echo "################################################################################"
	@echo "#                                                                              #"
	@echo "#  compile "$@
	@echo "#                                                                              #"
	@echo "################################################################################"
	$(RM) $(TARGET_OBJ)/$@;
	$(CC) $(INC) $(COPT) -static -o $(addprefix $(TARGET_OBJ)/, $(notdir $@)) \
	-fPIC -c $(subst $(O_SUFFIX),$(C_SUFFIX), $@) -lm;
	@echo "################################################################################"
	@echo "#                                                                              #"
	@echo "#                                                                              #"
	@echo "#                                                                              #"
	@echo "################################################################################"

%$(OXX_SUFFIX) :
	@echo "################################################################################"
	@echo "#                                                                              #"
	@echo "#  compile CXX "$@
	@echo "#                                                                              #"
	@echo "################################################################################"
	$(CXX) $(INC) $(COPT) -static -o $(addprefix $(TARGET_OBJ)/, $(notdir $@)) \
	-fpermissive -fPIC -c $(subst $(OXX_SUFFIX),$(CXX_SUFFIX), $@) -lm;
	@echo "################################################################################"
	@echo "#                                                                              #"
	@echo "#                                                                              #"
	@echo "#                                                                              #"
	@echo "################################################################################"

################################################################################
#                                                                              #
#                                    BUILD                                     #
#                                                                              #
################################################################################
% :
ifeq ($(OUTPUT_TYPE), .so)
	@echo "################################################################################"
	@echo "#                                                                              #"
	@echo "#  shared object "$(_TARGET_NAME)
	@echo "#                                                                              #"
	@echo "################################################################################"
	$(CC) -fPIC -shared $(COPT) -o $(OUT)/$(_TARGET_NAME) $(OBJS) $(xLIB);
	@echo "################################################################################"
	@echo "#                                                                              #"
	@echo "#                                                                              #"
	@echo "#                                                                              #"
	@echo "################################################################################"
endif
ifeq ($(OUTPUT_TYPE), .a)
	@echo "################################################################################"
	@echo "#                                                                              #"
	@echo "#  archive "$(_TARGET_NAME)
	@echo "#                                                                              #"
	@echo "################################################################################"
	$(AR) $(AR_OPT) $(OUT)/$(_TARGET_NAME) $(OBJS) $(xLIB);
	$(RANLIB) $(OUT)/$(_TARGET_NAME);
	@echo "################################################################################"
	@echo "#                                                                              #"
	@echo "#                                                                              #"
	@echo "#                                                                              #"
	@echo "################################################################################"
endif
ifeq ($(OUTPUT_TYPE), .out)
	@echo "################################################################################"
	@echo "#                                                                              #"
	@echo "#  binary "$(_TARGET_NAME)
	@echo "#                                                                              #"
	@echo "################################################################################"
	$(CC) -o $(OUT)/$(_TARGET_NAME) $(OBJS) $(INC) $(COPT) $(xLIB);
	@echo "################################################################################"
	@echo "#                                                                              #"
	@echo "#                                                                              #"
	@echo "#                                                                              #"
	@echo "################################################################################"
endif

all:
	@echo "################################################################################"
	@echo "#"
	@echo "#"
	@echo "#  Build Start "$(_OUTPUT_NAME)"  ("$(ARCH_TYPE)")" " ("$(OUTPUT_TYPE)") "
	@echo "#  "$(addsuffix $(O_SUFFIX),$(basename $(C_SRCS)))
	@echo "#"
	@echo "#"
	@echo "################################################################################"
	make $(addsuffix $(O_SUFFIX),$(basename $(C_SRCS)));
	@echo "################################################################################"
	@echo "#"
	@echo "#"
	@echo "#  link "$(_OUTPUT_NAME)
	@echo "#"
	@echo "#"
	@echo "################################################################################"
	make $(_OUTPUT_NAME);
	@echo "################################################################################"
	@echo "#"
	@echo "#"
	@echo "#  Build Complete "$(_OUTPUT_NAME)"  ("$(ARCH_TYPE)")"
	@echo "#"
	@echo "#"
	@echo "################################################################################"
	@echo " "
	@echo " "
	@echo " "
	@echo " "
	@echo " "
	@echo " "
	@echo " "
	@echo " "
	@echo " "
	@echo " "

################################################################################
#                                                                              #
#                                 BUILD PREFIX                                 #
#                                                                              #
################################################################################
dir:
	mkdir -p $(OUT);
	mkdir -p $(TARGET_OBJ);

clean :
	$(RM)  *.o core;
	$(RM)  $(TARGET_OBJ)/*.o;
	$(RM)  $(OUT)/$(_TARGET_NAME);

distclean:
	$(RM)  *.o core;
	$(RM)  $(OUT)/*;
	$(RM)  $(TARGET_OBJ)/*.o;
	$(RM)  $(OUT)/$(_TARGET_NAME);
